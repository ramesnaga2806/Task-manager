<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Task Manager</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background: #f7f9fc;
      color: #333;
    }

    h2 { 
      margin-bottom: 15px; 
      font-size: 26px;
      font-weight: 700;
      text-align: center;
      color: #2c3e50;
      background: linear-gradient(90deg, #3498db, #2ecc71);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.15);
    }

    form input, form textarea, form select, form button {
      margin: 5px 0; 
      display: block; 
      width: 100%; 
      max-width: 400px; 
      padding: 10px;
      border: 1px solid #ccc; 
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }

    form input:focus, form textarea:focus, form select:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 4px rgba(52, 152, 219, 0.5);
    }

    form button {
      background: #3498db;
      color: #fff;
      border: none;
      padding: 10px;
      cursor: pointer;
      border-radius: 6px;
      font-weight: bold;
      transition: background 0.3s ease;
    }

    form button:hover {
      background: #2980b9;
    }

    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin-top: 20px; 
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    table thead {
      background: #2c3e50;
      color: #fff;
    }

    th, td { 
      padding: 12px 10px; 
      text-align: left; 
      vertical-align: top; 
      border-bottom: 1px solid #ddd;
    }

    tr:hover {
      background: #f1f7ff;
    }

    button.complete-btn { 
      background-color: #28a745; 
      color: #fff; 
      border: none; 
      padding: 6px 12px; 
      cursor: pointer; 
      border-radius: 4px; 
      font-size: 13px;
      transition: background 0.3s ease;
    }

    button.complete-btn:hover {
      background-color: #218838;
    }

    td[contenteditable="true"] { 
      background: #fffbea; 
      border: 1px dashed #f0c36d;
    }

    select.status-select { 
      padding: 6px; 
      border-radius: 4px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>Task Manager</h2>
  <p><strong>Note 1:</strong> The transaction could not be saved in the data storage.</p>
  <p><strong>Note 2:</strong> Only the user who originally assigned the task is authorized to mark it as ‘Complete’.</p>

  <label for="departmentFilter"><strong>View Department:</strong></label>
  <select id="departmentFilter">
    <option value="All">All</option>
    <option value="Inbound">Inbound</option>
    <option value="Outbound">Outbound</option>
    <option value="Wave Planner">Wave Planner</option>
    <option value="Inventory">Inventory</option>
    <option value="Rework">Rework</option>
    <option value="Return">Return</option>
    <option value="PTC">PTC</option>
    <option value="PTL">PTL</option>
    <option value="Admin">Admin</option>
  </select>

  <form id="taskForm">
    <input type="text" id="title" placeholder="Title" required />
    <input type="text" id="emailSubject" placeholder="Email Subject (Optional)" />
    <input type="text" id="requestBy" placeholder="Request By" required />
    <textarea id="remark" placeholder="Remark"></textarea>
    <select id="department" required>
      <option value="">Select Department</option>
      <option value="Inbound">Inbound</option>
      <option value="Outbound">Outbound</option>
      <option value="Wave Planner">Wave Planner</option>
      <option value="Inventory">Inventory</option>
      <option value="Rework">Rework</option>
      <option value="Return">Return</option>
      <option value="PTC">PTC</option>
      <option value="PTL">PTL</option>
      <option value="Admin">Admin</option>
    </select>
    <button type="submit">Add Task</button>
  </form>

  <table id="taskTable">
    <thead>
      <tr>
        <th>Department</th><th>Title</th><th>Email Subject</th><th>Request By</th><th>Remark</th>
        <th>Created Date & Time</th><th>Incharge Person</th><th>Status of Progress</th>
        <th>Update Remark</th><th>Current Date & Time</th><th>Complete Task</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBsgq8DhQvh3gzDnRZV1OvinoQytOK7zi8",
      authDomain: "sswr-task-manager.firebaseapp.com",
      projectId: "sswr-task-manager",
      storageBucket: "sswr-task-manager.firebasestorage.app",
      messagingSenderId: "579546899458",
      appId: "1:579546899458:web:f03cbe676239a51925b31b",
      measurementId: "G-6BKJ4RDFVL"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const tasksCol = collection(db, "tasks");

    const taskForm = document.getElementById("taskForm");
    const taskTableBody = document.getElementById("taskTable").querySelector("tbody");
    const departmentFilter = document.getElementById("departmentFilter");

    function debounce(fn, wait = 10000) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), wait);
      };
    }

    function formatTimestamp(ts) {
      if (!ts) return "—";
      try { return ts.toDate().toLocaleString(); }
      catch (e) { return String(ts); }
    }

    // Add Task
    taskForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = document.getElementById("title").value.trim();
      const emailSubject = document.getElementById("emailSubject").value.trim();
      const requestBy = document.getElementById("requestBy").value.trim();
      const remark = document.getElementById("remark").value.trim();
      const department = document.getElementById("department").value;

      try {
        await addDoc(tasksCol, {
          department, title, emailSubject, requestBy, remark,
          createdDate: serverTimestamp(),
          inchargePerson: "",
          status: "Open",
          updateRemark: "",
          currentDate: serverTimestamp()
        });
        taskForm.reset();
      } catch (err) {
        console.error("Failed to save:", err);
      }
    });

    // Real-time listener
    const q = query(tasksCol, orderBy("createdDate", "desc"));
    onSnapshot(q, (snapshot) => {
      taskTableBody.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;
        const row = taskTableBody.insertRow();
        row.setAttribute("data-department", data.department || "");
        row.setAttribute("data-id", id);

        row.insertCell(0).innerText = data.department || "";
        row.insertCell(1).innerText = data.title || "";
        row.insertCell(2).innerText = data.emailSubject || "";
        row.insertCell(3).innerText = data.requestBy || "";
        row.insertCell(4).innerText = data.remark || "";
        row.insertCell(5).innerText = formatTimestamp(data.createdDate);

        const inchargeCell = row.insertCell(6);
        inchargeCell.contentEditable = "true";
        inchargeCell.innerText = data.inchargePerson || "";

        const statusCell = row.insertCell(7);
        const select = document.createElement("select");
        select.className = "status-select";
        ["Open", "Progress", "Complete"].forEach(optText => {
          const opt = document.createElement("option");
          opt.value = optText;
          opt.textContent = optText;
          select.appendChild(opt);
        });
        select.value = data.status || "Open";
        statusCell.appendChild(select);

        const updateRemarkCell = row.insertCell(8);
        updateRemarkCell.contentEditable = "true";
        updateRemarkCell.innerText = data.updateRemark || "";

        row.insertCell(9).innerText = formatTimestamp(data.currentDate);

        const completeCell = row.insertCell(10);
        const completeBtn = document.createElement("button");
        completeBtn.textContent = "Complete Task";
        completeBtn.className = "complete-btn";
        completeCell.appendChild(completeBtn);

        const docRef = doc(db, "tasks", id);

        // Separate timers for Incharge Person and Update Remark
        const lastIncharge = { value: data.inchargePerson || "" };
        const lastRemark = { value: data.updateRemark || "" };

        const debounceIncharge = debounce(async () => {
          if (inchargeCell.innerText !== lastIncharge.value) {
            await updateDoc(docRef, {
              inchargePerson: inchargeCell.innerText,
              currentDate: serverTimestamp()
            });
            lastIncharge.value = inchargeCell.innerText;
          }
        }, 10000);

        const debounceRemark = debounce(async () => {
          if (updateRemarkCell.innerText !== lastRemark.value) {
            await updateDoc(docRef, {
              updateRemark: updateRemarkCell.innerText,
              currentDate: serverTimestamp()
            });
            lastRemark.value = updateRemarkCell.innerText;
          }
        }, 10000);

        inchargeCell.addEventListener("input", debounceIncharge);
        updateRemarkCell.addEventListener("input", debounceRemark);

        // Status update
        select.addEventListener("change", async () => {
          const newStatus = select.value;
          try {
            await updateDoc(docRef, { status: newStatus, currentDate: serverTimestamp() });
          } catch (err) {
            console.error("Error updating status:", err);
          }
        });

        // Complete button
        completeBtn.addEventListener("click", async () => {
          try {
            await deleteDoc(docRef);
            row.remove();
          } catch (err) {
            console.error("Error deleting task:", err);
          }
        });
      });
      applyFilter();
    });

    departmentFilter.addEventListener("change", applyFilter);
    function applyFilter() {
      const sel = departmentFilter.value;
      for (let r of taskTableBody.rows) {
        const dept = r.getAttribute("data-department") || "";
        r.style.display = (sel === "All" || dept === sel) ? "" : "none";
      }
    }
  </script>
</body>
</html>
